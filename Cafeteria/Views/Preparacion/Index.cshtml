@model List<Cafeteria.ViewModels.PedidoAgrupadoViewModel>

@{
    ViewBag.Title = "Preparación de Pedidos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Preparación de Pedidos</h2>

<div style="display: flex;">
    <!-- Izquierda: Lista de botones por producto -->
    <div style="width: 40%; padding: 10px;">
        @foreach (var pedido in Model)
        {
            int index = 0;
            foreach (var producto in pedido.Productos)
            {
                <button class="btn btn-primary btn-block pedido-btn"
                        data-id="@pedido.IdPedido"
                        data-nombre="@pedido.NombreCliente"
                        data-producto="@producto.Nombre"
                        data-ingredientes="@producto.Ingredientes"
                        id="boton-@pedido.IdPedido-@index">
                    Orden @pedido.IdPedido - @pedido.NombreCliente - @producto.Nombre
                </button>
                index++;
            }
        }
    </div>

    <!-- Derecha: Detalles del producto -->
    <div style="width: 60%; padding: 10px;">
        <div id="detallePedido" style="display: none; border: 1px solid #ccc; padding: 10px;">
            <h4 id="tituloProducto"></h4>
            <p><strong>Ingredientes:</strong> <span id="ingredientesProducto"></span></p>

            <button id="btnEntregar" class="btn btn-success">Entregado</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let idPedidoSeleccionado = null;
        let botonSeleccionado = null;

        document.querySelectorAll('.pedido-btn').forEach(boton => {
            boton.addEventListener('click', function () {
                idPedidoSeleccionado = this.dataset.id;
                botonSeleccionado = this;

                document.getElementById('tituloProducto').textContent = this.dataset.producto;
                document.getElementById('ingredientesProducto').textContent = this.dataset.ingredientes;

                document.getElementById('detallePedido').style.display = 'block';
            });
        });

        document.getElementById('btnEntregar').addEventListener('click', function () {
            if (!idPedidoSeleccionado || !botonSeleccionado) return;

            fetch('/Preparacion/CambiarEstado', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `idPedido=${idPedidoSeleccionado}&nuevoEstado=Entregado`
            })
                .then(res => {
                    if (res.ok) {
                        botonSeleccionado.style.backgroundColor = '#a4f9a4'; // verde

                        setTimeout(() => {
                            botonSeleccionado.remove();
                            document.getElementById('detallePedido').style.display = 'none';
                        }, 3000);
                    } else {
                        alert("Error al cambiar el estado");
                    }
                })
                .catch(err => alert("Error: " + err));
        });
    </script>
}
